# Wide Research 输出规范

本文档定义了 Wide Research 流程的严格输出结构，所有执行必须遵循此规范。

---

## 工作目录命名规范

### 格式
```
runs/<YYYYMMDD>-<task-slug>-<random-hex>/
```

### 组成部分
| 部分 | 格式 | 示例 |
|-----|------|-----|
| 日期 | `YYYYMMDD` | `20260106` |
| 任务摘要 | 小写字母+连字符，≤30字符 | `ai-code-assistant-market` |
| 随机后缀 | 6位十六进制 | `a3f2c1` |

### 完整示例
```
runs/20260106-ai-code-assistant-market-a3f2c1/
runs/20260106-llm-security-research-b7e9d4/
runs/20260106-competitor-analysis-2024-c5a8f0/
```

### 命名规则
1. 任务摘要必须能够一眼识别调研主题
2. 使用连字符分隔单词，不使用下划线或空格
3. 避免使用 "research"、"analysis" 等冗余词
4. 随机后缀防止目录名冲突

---

## 目录结构规范

```
runs/<工作目录>/
│
├── metadata.json           # [必需] 任务元数据
├── subtasks.json           # [必需] 子任务定义
│
├── raw/                    # [必需] 原始抓取数据（缓存层）
│   ├── tavily_<hash>.json  # Tavily API 响应
│   ├── page_<hash>.html    # 网页原始内容
│   └── api_<hash>.json     # 其他 API 响应
│
├── prompts/                # [必需] 子代理 Prompt 文件
│   ├── subtask_001.md
│   ├── subtask_002.md
│   └── ...
│
├── outputs/                # [必需] 子代理输出
│   ├── subtask_001.md
│   ├── subtask_002.md
│   └── ...
│
├── logs/                   # [必需] 执行日志
│   ├── orchestrator.log    # 主控日志
│   ├── subtask_001.log     # 子任务日志
│   └── ...
│
├── tmp/                    # [可选] 临时文件（可清理）
│
├── cache/                  # [可选] 处理缓存
│
├── aggregated_raw.md       # [必需] 聚合原始输出
├── polish_outline.md       # [必需] 润色大纲
└── final_report.md         # [必需] 最终交付物
```

---

## 核心文件规范

### 1. metadata.json

**用途**: 记录任务元信息，支持追溯和复现

```json
{
  "version": "1.0",
  "task": {
    "name": "AI 代码助手市场分析",
    "description": "调研 AI 代码助手市场的主要产品、定价和趋势",
    "user_query": "<用户原始请求>",
    "dimensions": ["产品", "定价", "功能", "用户评价"]
  },
  "execution": {
    "created_at": "2026-01-06T12:00:00Z",
    "started_at": "2026-01-06T12:05:00Z",
    "completed_at": "2026-01-06T12:45:00Z",
    "status": "completed",
    "phases_completed": ["phase0", "phase1", "phase2", "phase3", "phase4", "phase5"]
  },
  "subtasks": {
    "total": 6,
    "success": 5,
    "failed": 0,
    "timeout": 1,
    "partial": 0
  },
  "statistics": {
    "total_searches": 24,
    "total_extracts": 12,
    "cache_hit_rate": 0.35,
    "total_references": 48,
    "final_word_count": 8500
  },
  "quality": {
    "depth_score": "high",
    "coverage_score": "complete",
    "review_passed": true,
    "review_notes": ""
  }
}
```

### 2. subtasks.json

**用途**: 定义所有子任务及其状态

```json
{
  "version": "1.0",
  "generated_at": "2026-01-06T12:05:00Z",
  "subtasks": [
    {
      "id": "subtask_001",
      "name": "调研 GitHub Copilot",
      "dimension": "产品分析",
      "priority": 1,
      "targets": [
        "https://github.com/features/copilot",
        "https://docs.github.com/copilot"
      ],
      "constraints": {
        "max_search_rounds": 10,
        "timeout_minutes": 5,
        "focus_areas": ["功能", "定价", "用户反馈"]
      },
      "status": "completed",
      "output_file": "outputs/subtask_001.md",
      "log_file": "logs/subtask_001.log",
      "started_at": "2026-01-06T12:10:00Z",
      "completed_at": "2026-01-06T12:15:00Z",
      "result": {
        "reference_count": 8,
        "word_count": 1200,
        "quality": "good"
      }
    }
  ]
}
```

### 3. aggregated_raw.md

**用途**: 聚合所有子任务原始输出，保留完整信息

**格式规范**:
```markdown
# 聚合报告 - <任务名称>

> 生成时间: <ISO时间戳>
> 子任务数量: X | 成功: Y | 失败: Z | 超时: W

---

## 子任务 1: <名称>

**状态**: ✅ 成功 | ❌ 失败 | ⏱️ 超时 | ⚠️ 部分完成
**引用数**: X | **字数**: Y

<子任务完整输出>

---

## 子任务 2: <名称>
...

---

## 聚合统计

| 指标 | 值 |
|-----|---|
| 总引用数 | X |
| 总字数 | Y |
| 覆盖维度 | [列表] |
| 缺失维度 | [列表] |
```

### 4. polish_outline.md

**用途**: 润色阶段的章节规划

**格式规范**:
```markdown
# 润色大纲 - <任务名称>

## 目标受众
<描述目标读者>

## 报告定位
<简报/深度分析/综述/白皮书>

## 章节结构

### 1. 执行摘要
- **核心论点**: <一句话核心结论>
- **素材来源**: 子任务 X, Y, Z
- **预计字数**: 300-500

### 2. 背景与方法论
- **核心论点**: <研究背景和方法说明>
- **素材来源**: 摸底阶段, metadata.json
- **预计字数**: 200-400

### 3. 主要发现
#### 3.1 <维度A>
- **核心论点**: ...
- **素材来源**: 子任务 X
- **关键数据**: ...

#### 3.2 <维度B>
...

### 4. 深度分析
- **核心论点**: <跨维度洞察>
- **素材来源**: 多个子任务交叉分析

### 5. 结论与建议
- **核心论点**: <可执行建议>
- **素材来源**: 全文总结

### 6. 附录
- 数据来源清单
- 方法论详述
- 局限性说明

## 质量要求
- [ ] 每章节独立可读
- [ ] 引用格式统一
- [ ] 数据有时间标注
- [ ] 洞察而非罗列
```

### 5. final_report.md

**用途**: 最终交付物，面向用户的正式报告

**格式规范**:
```markdown
# <报告标题>

> **调研日期**: YYYY-MM-DD
> **调研范围**: <简述>
> **数据来源**: X 个主要来源

---

## 执行摘要

<300-500字核心结论，包含关键数据点>

---

## 目录

1. [背景与方法](#1-背景与方法)
2. [主要发现](#2-主要发现)
3. [深度分析](#3-深度分析)
4. [结论与建议](#4-结论与建议)
5. [附录](#5-附录)

---

## 1. 背景与方法

### 1.1 研究背景
<为什么做这个调研>

### 1.2 研究方法
<如何收集和分析数据>

### 1.3 研究范围
<覆盖了什么，不覆盖什么>

---

## 2. 主要发现

### 2.1 <维度A标题>

**核心结论**：<一句话概括此维度的核心发现>

**原文摘录**：
> "引用1原文" —— 来源A [链接](URL)
> "引用2原文" —— 来源B [链接](URL)
> "引用3原文" —— 来源C [链接](URL)

**深入分析**：
<基于原文摘录的深入分析，解释这些证据如何支撑核心结论>

### 2.2 <维度B标题>
<同上结构...>

---

## 3. 深度分析

### 3.1 趋势洞察
<跨维度分析>

### 3.2 对比分析
<如适用>

### 3.3 风险与机会
<如适用>

---

## 4. 结论与建议

### 4.1 核心结论
1. <结论1>
2. <结论2>
3. <结论3>

### 4.2 可执行建议
| 建议 | 优先级 | 依据 |
|-----|-------|-----|
| ... | 高/中/低 | ... |

### 4.3 后续跟进
<待确认事项和建议的下一步>

---

## 5. 附录

### 5.1 数据来源清单

| 来源 | 类型 | 访问日期 |
|-----|------|---------|
| [名称](URL) | 官方/第三方/用户评价 | YYYY-MM-DD |

### 5.2 方法论详述
<如需要>

### 5.3 局限性说明
- <局限性1>
- <局限性2>

---

*本报告由 Wide Research 多实例编排系统生成*
*工作目录: `runs/<目录名>/`*
```

---

## 三层报告结构规范（强制）

最终报告必须采用三层结构，确保结论可追溯、可验证：

### 第一层：核心洞察层
- 位置：执行摘要 + 各章节开头
- 内容：3-5 个核心结论
- 要求：每个结论用 1-2 句话表达，直击要点

### 第二层：证据支撑层
- 位置：每个核心结论之后
- 内容：3-5 条原文摘录，支撑上述结论
- 要求：必须是**直接引用**（加引号），不得改写
- 格式：
  ```markdown
  > "原文引用内容" —— 来源名称 [链接](URL)
  ```

### 第三层：完整素材层
- 位置：附录 或 可折叠区域
- 内容：所有子任务的详细输出、原始数据链接
- 要求：分类整理，便于深入查阅

### 三层结构示例

```markdown
## 2. 主要发现

### 2.1 [核心发现标题]

**结论**：
[1-2 句话概括核心发现，直击要点]

**原文摘录**：
> "[原始引用1]" —— 来源A [链接](URL)
> "[原始引用2]" —— 来源B [链接](URL)
> "[原始引用3]" —— 来源C [链接](URL)

**分析**：
[基于上述证据的深入分析，解释证据如何支撑结论，以及更广泛的意义]
```

**注意**：上述结构适用于任何调研类型——产品调研、市场分析、技术评估、文献综述等。核心是"结论-证据-分析"的三段式。

### 引用密度指标

| 报告类型 | 核心结论数 | 每结论原文摘录数 | 总引用数下限 |
|---------|----------|----------------|------------|
| 快速调研 | 3-5 | ≥2 | 10 |
| 标准调研 | 5-8 | ≥3 | 25 |
| 深度调研 | 8-12 | ≥5 | 50 |

**强制规则**：不满足引用密度指标的报告视为不合格，需补充证据后重新提交。

---

## 引用格式规范

### 内联引用（强制）

```markdown
✅ 正确:
GitHub Copilot 的月活用户超过 130 万 [GitHub Blog](https://github.blog/2024-copilot-stats)。

❌ 错误:
GitHub Copilot 的月活用户超过 130 万。[1]

参考文献:
[1] https://github.blog/2024-copilot-stats
```

### 数据标注（强制）

```markdown
✅ 正确:
市场规模: $50B (2024年预测, Gartner, 2024-01)

❌ 错误:
市场规模: $50B
```

---

## 文件命名规范

### 子任务文件

| 类型 | 格式 | 示例 |
|-----|------|-----|
| Prompt | `subtask_<NNN>.md` | `subtask_001.md` |
| Output | `subtask_<NNN>.md` | `subtask_001.md` |
| Log | `subtask_<NNN>.log` | `subtask_001.log` |

### 缓存文件

| 类型 | 格式 | 示例 |
|-----|------|-----|
| Tavily 响应 | `tavily_<md5_hash>.json` | `tavily_a3f2c1b7.json` |
| 网页内容 | `page_<md5_hash>.html` | `page_e9d4f0a2.html` |
| API 响应 | `api_<source>_<hash>.json` | `api_github_c5b8a1.json` |

---

## 质量检查清单

### Phase 3 完成后（聚合前）

- [ ] 所有 prompts/*.md 文件存在
- [ ] 所有 outputs/*.md 文件存在或有失败记录
- [ ] 所有 logs/*.log 文件记录完整
- [ ] subtasks.json 状态已更新

### Phase 4 完成后（润色前）

- [ ] aggregated_raw.md 已生成
- [ ] 聚合统计准确
- [ ] 无空白子任务输出（失败的有说明）

### Phase 5 完成后（交付前）

- [ ] polish_outline.md 存在
- [ ] final_report.md 存在
- [ ] 报告分章节完成（非一次性生成）
- [ ] 所有引用为内联格式
- [ ] 所有数据有时间标注
- [ ] metadata.json 已更新完成状态

---

## 禁止行为

1. **禁止**在最终报告中直接拼接子任务原始输出
2. **禁止**一次性生成整篇报告（必须逐章）
3. **禁止**在聊天中贴出完整报告（只提供路径）
4. **禁止**使用集中式引用（必须内联）
5. **禁止**省略数据时间标注
6. **禁止**覆盖已有工作目录（每次新建）
