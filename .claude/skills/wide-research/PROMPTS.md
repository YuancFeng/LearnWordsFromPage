# Wide Research 子代理 Prompt 模板

本文档提供标准化的子代理 prompt 模板，确保并行执行的子任务产出一致、高质量的结果。

---

## 模板设计原则

1. **结构清晰** - 目标、约束、输出格式必须明确
2. **自包含** - 子代理不依赖主控上下文
3. **失败友好** - 内置错误处理和降级机制
4. **时间受限** - 明确检索轮数和超时限制
5. **证据优先** - 发现型任务必须提取原文摘录，禁止只输出裸结论
6. **格式强制** - 输出格式不是建议，是强制要求
7. **两维度适配** - 根据数据来源和输出格式选择对应规则
8. **🆕 增量写入** - 每完成一个发现立即写入文件，防止 auto-compaction 内容丢失

---

## 🎯 两维度正交模板选择

**在选择模板前，必须先判断两个维度（参见 SKILL.md 规则 0）：**

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      维度一 × 维度二 = 模板选择                          │
├─────────────────────┬───────────────────┬───────────────────────────────┤
│                     │ 📊 结构化输出     │ 📝 叙事性输出                 │
│                     │ (JSON/表格/清单)   │ (报告/综述/分析)              │
├─────────────────────┼───────────────────┼───────────────────────────────┤
│ 🔍 发现型           │ 产品对比模板      │ 市场分析模板                  │
│ （需主动搜索发现）    │ 技术对比模板      │ 通用调研模板                  │
│                     │                   │ 学术文献调研模板              │
│                     │ 证据密度 ≥3       │ 证据密度 ≥3                   │
│                     │ 原文摘录：强制    │ 原文摘录：强制                │
├─────────────────────┼───────────────────┼───────────────────────────────┤
│ 📦 处理型           │ 数据提取模板 ⭐   │ 内容整理模板 ⭐               │
│ （数据源已知）        │ 批量爬取模板      │ 内容整理模板                  │
│                     │                   │                               │
│                     │ 完整性 ≥95%       │ 覆盖率 ≥95%                   │
│                     │ 原文摘录：可选    │ 原文摘录：可选                │
└─────────────────────┴───────────────────┴───────────────────────────────┘
```

**⭐ 标记为处理型专用模板（规则更宽松）**

### 维度判断快速参考

**维度一：数据来源（Phase 0 判断）**

| 问自己 | 答案 | 维度一类型 |
|-------|------|-----------|
| "执行这个任务需要去找数据源吗？" | 是，需要搜索 | 🔍 发现型 |
| "执行这个任务需要去找数据源吗？" | 否，已经给了 | 📦 处理型 |

**维度二：输出格式（Phase 2 判断）**

| 用户需要什么？ | 维度二类型 | 跳转模板 |
|--------------|-----------|---------|
| 表格/JSON/清单/对比 | 📊 结构化 | → 数据提取/对比模板 |
| 报告/综述/分析/洞察 | 📝 叙事性 | → 调研/综述模板 |

### 组合示例

| 任务 | 维度一 | 维度二 | 使用规则 |
|------|--------|--------|---------|
| "调研 RAG 技术最新进展" | 🔍 发现 | 📝 叙事 | 严格证据链 |
| "给我一个 RAG 框架对比表" | 🔍 发现 | 📊 结构 | 严格证据链 |
| "整理这 10 篇论文的核心观点" | 📦 处理 | 📝 叙事 | 完整性优先 |
| "从这些 URL 提取产品价格" | 📦 处理 | 📊 结构 | 完整性优先 |

---

## ⚠️ 核心强制规则：原文摘录（🔍 发现型任务强制）

**这是发现型任务子代理执行的最重要规则，违反此规则的输出视为无效。**

> ⚠️ **注意**：此规则仅适用于 **🔍 发现型** 任务。**📦 处理型** 任务以数据完整性为核心指标，原文摘录为可选。

### 有效输出 vs 无效输出

```markdown
❌ 无效输出（将被退回）：
市场普遍看好这个技术方向。

❌ 无效输出（改写不算原文）：
市场普遍看好这个技术方向。
> 行业预期增长率将达到40% —— 某报告

✅ 有效输出（保持原文，标注来源）：
市场普遍看好这个技术方向。

原文摘录：
> "We expect 40% CAGR through 2027" —— Gartner Report [链接](URL)
> "This is the most promising approach we've seen" —— 来源B [链接](URL)
> "投资者对这个赛道的热情明显上升" —— 来源C [链接](URL)
```

### 原文提取核心要求

| 要求 | 说明 | 违规后果 |
|-----|------|---------|
| **直接引用** | 用引号包裹原始文本，保持原样 | 改写=无效 |
| **标注来源** | 出处名称 + 可点击 URL | 无链接=无效 |
| **数量要求** | 每个核心发现 ≥3 条 | <3条=不完整 |
| **多样性** | 不同来源、不同视角 | 单一来源=质量低 |

### 自检问题（输出前必答）

每个发现输出前，必须能回答以下 3 个问题：

1. **"原话是怎么说的？"**
   - ✅ 能指出具体引文（带引号）
   - ❌ 只能复述大意

2. **"在哪里可以验证？"**
   - ✅ 有可点击的 URL
   - ❌ "某报告说"、"有人认为"

3. **"这 3 条原文分别说明什么？"**
   - ✅ 每条原文有独立价值，相互补充
   - ❌ 3 条说的是同一件事

---

## 🆕 子代理增量写入模式（防止 Auto-Compaction 内容丢失）

**问题**：子代理执行多轮检索时，如果在中途发生 auto-compaction，之前积累在内存中的发现会全部丢失。

**解决方案**：每完成一个发现，立即写入文件，而非在内存中积累后一次性写入。

### 增量写入流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│  ❌ 危险模式（当前默认）                                                  │
│  执行 8 轮检索 → 内存中积累 8 个发现 → 最后一次性写入                      │
│  风险：第 6 轮 compaction 后，发现 1-5 全部丢失                           │
├─────────────────────────────────────────────────────────────────────────┤
│  ✅ 安全模式（增量写入）                                                  │
│  发现 1 → 立即写入 → 发现 2 → 立即追加 → ... → 发现 8 → 立即追加          │
│  即使第 6 轮 compaction，发现 1-5 已安全保存在文件中                       │
└─────────────────────────────────────────────────────────────────────────┘
```

### 子代理 Prompt 增量写入指令模板

**以下内容必须嵌入每个子代理 Prompt 中：**

```markdown
## 增量写入模式【强制遵守】

⚠️ 为防止 auto-compaction 导致内容丢失，必须采用增量写入：

### 执行流程

1. **首次写入**（完成第一个发现后）：
   ```
   Write("$WORK_DIR/outputs/subtask_XX.md", <文件头 + 发现1 + 占位符>)
   ```

2. **后续追加**（每完成一个发现）：
   ```
   Edit("$WORK_DIR/outputs/subtask_XX.md",
        old_string="---\n\n## 证据汇总表",
        new_string="---\n\n### 发现 N: [新发现]\n[内容]\n\n---\n\n## 证据汇总表")
   ```

3. **最终更新**（所有发现完成后）：
   - 更新证据汇总表
   - 添加完成状态

### 文件结构（支持增量追加）

```markdown
# 子任务: {{TASK_NAME}}

## ⚠️ 格式合规声明
本输出采用增量写入模式，每个发现完成后立即写入。

---

### 发现 1: [标题]

**结论**：[...]

**原文摘录**（≥3条）：
> "[原文1]" —— 来源 [链接](URL)
> "[原文2]" —— 来源 [链接](URL)
> "[原文3]" —— 来源 [链接](URL)

**分析**：[...]

---

### 发现 2: [标题]
[后续发现在此处插入]

---

## 证据汇总表
| # | 原文摘要 | 来源 | URL |
|---|---------|------|-----|
[最后统一更新]

## 完成状态
- 发现数: X
- 证据密度: X.X
- 写入模式: 增量写入
```

### 关键规则

| 规则 | 正确做法 | 错误做法 |
|-----|---------|---------|
| 写入时机 | ✅ 每完成一个发现立即写入 | ❌ 积累所有发现后一次性写入 |
| 写入方式 | ✅ 首次 Write，后续 Edit 追加 | ❌ 每次 Write 覆盖整个文件 |
| 插入位置 | ✅ 在"证据汇总表"前插入新发现 | ❌ 在文件末尾追加 |
| 重复检查 | ✅ 写入前读取文件检查已有发现数 | ❌ 不检查直接写入 |

### 示例：增量写入执行过程

```
Step 1: 完成发现 1
→ Write("outputs/subtask_01.md", "# 子任务...\n### 发现 1...\n---\n## 证据汇总表...")

Step 2: 完成发现 2
→ Read("outputs/subtask_01.md") // 确认发现 1 存在
→ Edit("outputs/subtask_01.md",
       old="---\n\n## 证据汇总表",
       new="---\n\n### 发现 2...\n---\n\n## 证据汇总表")

Step 3: 完成发现 3
→ Read("outputs/subtask_01.md") // 确认发现 1, 2 存在
→ Edit(...) // 追加发现 3

Step 4: 🔴 Auto-Compaction 发生！
→ 子代理"忘记"了之前的上下文
→ 但文件中已保存 发现 1, 2, 3！

Step 5: 继续执行
→ Read("outputs/subtask_01.md") // 恢复状态
→ 继续追加 发现 4, 5...
```
```

---

## 🔴 子代理强制输出格式（必须完整嵌入 Prompt）

以下格式模板必须**完整嵌入**每个子代理的 Prompt 中，不得省略或简化：

```markdown
## 输出格式【强制遵守，缺少任何部分视为无效输出】

### ⚠️ 格式合规声明
本输出严格遵循 Wide Research 证据链规范。每个发现均包含 ≥3 条原文摘录。

---

### 发现 1: [标题]

**结论**（1-2句）：
[简洁陈述核心发现]

**原文摘录**（≥3条，缺一不可）：
> "[原文1 - 必须是完整原句，不得改写]" —— [来源名称] [链接](URL)
> "[原文2 - 必须是完整原句，不得改写]" —— [来源名称] [链接](URL)
> "[原文3 - 必须是完整原句，不得改写]" —— [来源名称] [链接](URL)

**分析**（基于上述原文）：
[解释这些证据如何支撑结论，以及更广泛的意义]

---

### 发现 2: [标题]
[同上结构...]

---

### 发现 3: [标题]
[同上结构...]

---

## 证据汇总表

| # | 原文摘要 | 来源 | URL | 支撑发现 |
|---|---------|------|-----|---------|
| 1 | [前20字...] | [来源名] | [链接](URL) | 发现1 |
| 2 | [前20字...] | [来源名] | [链接](URL) | 发现1 |
| ... | ... | ... | ... | ... |

**证据密度统计**：共 X 条原文，支撑 Y 个发现，密度 = X/Y

---

## 局限性说明
- [数据覆盖范围]
- [时效性说明]
- [潜在偏差]

---

## ⛔ 输出禁止清单
- 禁止输出没有原文摘录的发现
- 禁止将原文改写后充当"摘录"
- 禁止使用"据报道"、"有人认为"等模糊来源
- 禁止原文少于 3 条的核心发现
```

---

## 通用调研 Prompt 完整模板

**主控使用此模板生成子代理 Prompt，必须完整复制，仅替换 `{{变量}}`：**

```markdown
# 子任务: {{TASK_NAME}}

## 背景
{{CONTEXT}}

## 目标
{{OBJECTIVE}}

## 数据源
- 主要来源: {{PRIMARY_SOURCES}}
- 备选来源: {{SECONDARY_SOURCES}}

## 约束条件
- Tavily/Firecrawl 检索总轮数不超过 {{MAX_SEARCH_ROUNDS}} 轮
- 必要信息齐全即可结束，不追求完美覆盖
- 总执行时间不超过 {{TIMEOUT_MINUTES}} 分钟
- 不使用 EnterPlanMode 或 AskUserQuestion
- 遇到障碍时自行决策，不等待外部确认

## 工具使用优先级
1. 优先使用 MCP 工具 (tavily_search, tavily_extract, firecrawl_scrape)
2. 仅在 MCP 不可用时使用 WebFetch/WebSearch
3. 所有原始数据写入工作目录缓存

## 输出格式【强制遵守，缺少任何部分视为无效输出】

### ⚠️ 格式合规声明
本输出严格遵循 Wide Research 证据链规范。每个发现均包含 ≥3 条原文摘录。

---

### 发现 1: [标题]

**结论**（1-2句）：
[简洁陈述核心发现]

**原文摘录**（≥3条，缺一不可）：
> "[原文1 - 必须是完整原句，不得改写]" —— [来源名称] [链接](URL)
> "[原文2 - 必须是完整原句，不得改写]" —— [来源名称] [链接](URL)
> "[原文3 - 必须是完整原句，不得改写]" —— [来源名称] [链接](URL)

**分析**（基于上述原文）：
[解释这些证据如何支撑结论]

---

### 发现 2: [标题]
[同上结构...]

---

### 发现 3: [标题]
[同上结构...]

---

## 证据汇总表

| # | 原文摘要 | 来源 | URL | 支撑发现 |
|---|---------|------|-----|---------|
| 1 | [前20字...] | [来源名] | [链接](URL) | 发现1 |
| ... | ... | ... | ... | ... |

**证据密度统计**：共 X 条原文，支撑 Y 个发现，密度 = X/Y

---

## 局限性说明
- [数据覆盖范围]
- [时效性说明]
- [潜在偏差]

---

## ⛔ 输出禁止清单（违反任一条将导致输出被退回）
- 禁止输出没有原文摘录的发现
- 禁止将原文改写后充当"摘录"
- 禁止使用"据报道"、"有人认为"等模糊来源
- 禁止原文少于 3 条的核心发现

## 增量写入模式【强制遵守】

⚠️ 为防止 auto-compaction 导致内容丢失，必须采用增量写入：

1. **首次写入**：完成第一个发现后，立即创建输出文件
2. **后续追加**：每完成一个发现，使用 Edit 追加到文件（在"证据汇总表"前插入）
3. **写入前检查**：读取文件确认已有发现数，避免重复

关键规则：
- ✅ 每完成一个发现，立即写入文件
- ✅ 使用 Edit 工具追加（在"证据汇总表"前插入）
- ❌ 禁止在内存中积累所有发现后一次性写入
- ❌ 禁止用 Write 覆盖已有内容

## 如遇失败
如无法完成任务，输出：

### 失败报告
- 失败原因: [具体原因]
- 已完成部分: [列出已获取的信息，仍需遵循原文摘录格式]
- 后续建议: [建议的替代方案]
```

---

## 产品调研模板

```markdown
# 产品调研: {{PRODUCT_NAME}}

## 目标
全面调研 {{PRODUCT_NAME}} 的产品定位、核心功能、定价策略和用户反馈。

## 数据源
- 官方网站: {{OFFICIAL_URL}}
- 文档/博客: {{DOCS_URL}}
- 用户评价平台: G2, Capterra, Product Hunt, Reddit

## 约束
- 检索轮数: ≤10 轮
- 优先官方信息，用户评价作为补充
- 关注最近 12 个月的更新
- 不使用 EnterPlanMode 或 AskUserQuestion

## 输出格式【强制遵守】

### ⚠️ 格式合规声明
本输出严格遵循 Wide Research 证据链规范。每个发现均包含 ≥3 条原文摘录。

---

### 发现 1: 产品定位与核心价值

**结论**：
[陈述产品定位]

**原文摘录**（≥3条）：
> "[官方描述原文]" —— 官方网站 [链接](URL)
> "[用户评价原文]" —— 评价平台 [链接](URL)
> "[媒体报道原文]" —— 媒体来源 [链接](URL)

**分析**：
[基于证据的分析]

---

### 发现 2: 核心功能与差异化

**结论**：
[陈述核心功能]

**原文摘录**（≥3条）：
> "[功能描述原文]" —— 来源 [链接](URL)
> "[用户反馈原文]" —— 来源 [链接](URL)
> "[对比评测原文]" —— 来源 [链接](URL)

**分析**：
[功能分析]

---

### 发现 3: 定价策略

**结论**：
[陈述定价策略]

**原文摘录**（≥3条）：
> "[定价信息原文]" —— 官方定价页 [链接](URL)
> "[用户对价格的评价]" —— 来源 [链接](URL)
> "[与竞品价格对比]" —— 来源 [链接](URL)

**分析**：
[定价分析]

---

### 发现 4: 用户反馈与口碑

**结论**：
[陈述用户反馈]

**原文摘录**（≥3条正面 + ≥3条负面）：
> "[正面评价1]" —— 来源 [链接](URL)
> "[正面评价2]" —— 来源 [链接](URL)
> "[负面评价1]" —— 来源 [链接](URL)
> "[负面评价2]" —— 来源 [链接](URL)

**分析**：
[口碑分析]

---

## 证据汇总表
| # | 原文摘要 | 来源 | URL | 支撑发现 |
|---|---------|------|-----|---------|
| 1 | ... | ... | [链接](URL) | 发现1 |
| ... | ... | ... | ... | ... |

**证据密度统计**：共 X 条原文，支撑 Y 个发现

---

## ⛔ 输出禁止清单
- 禁止输出没有原文摘录的发现
- 禁止将原文改写后充当"摘录"
- 禁止原文少于 3 条的核心发现
```

---

## 技术文档调研模板

```markdown
# 技术调研: {{TECHNOLOGY_NAME}}

## 目标
调研 {{TECHNOLOGY_NAME}} 的技术架构、使用方法和生态系统。

## 数据源
- 官方文档: {{DOCS_URL}}
- GitHub 仓库: {{GITHUB_URL}}
- 技术博客/教程

## 约束
- 检索轮数: ≤8 轮
- 关注稳定版本，标记实验性功能
- 代码示例需验证可运行

## 输出结构

### 1. 技术概述
- 是什么: [一句话定义]
- 解决什么问题: [核心价值]
- 适用场景: [列表]

### 2. 核心概念
| 概念 | 定义 | 重要性 |
|-----|------|-------|
| ... | ... | 核心/重要/辅助 |

### 3. 架构设计
[架构图或文字描述]

### 4. 快速上手
```bash
# 安装
[安装命令]

# 基本使用
[示例代码]
```

### 5. 生态系统
- 核心依赖: ...
- 常用插件/扩展: ...
- 社区活跃度: [评估]

### 6. 优缺点
| 优点 | 缺点 |
|-----|-----|
| ... | ... |

### 7. 参考资料
[链接列表]
```

---

## 市场分析模板

```markdown
# 市场分析: {{MARKET_NAME}}

## 目标
分析 {{MARKET_NAME}} 市场的规模、主要玩家、趋势和机会。

## 数据源
- 行业报告: Gartner, Forrester, IDC
- 新闻媒体: TechCrunch, VentureBeat
- 公司财报/PR

## 约束
- 检索轮数: ≤12 轮
- 数据需标注时间和来源
- 区分事实和预测

## 输出结构

### 1. 市场概况
- 市场定义: [范围和边界]
- 市场规模: $X (年份, 来源)
- 增长率: X% CAGR (时间范围, 来源)

### 2. 主要玩家
| 公司 | 市场份额 | 核心产品 | 融资/估值 |
|-----|---------|---------|----------|
| ... | ... | ... | ... |

### 3. 市场趋势
1. **趋势1**: [描述] [来源](URL)
2. **趋势2**: [描述] [来源](URL)
3. **趋势3**: [描述] [来源](URL)

### 4. 驱动因素
- 增长驱动: ...
- 抑制因素: ...

### 5. 机会与威胁
| 机会 | 威胁 |
|-----|-----|
| ... | ... |

### 6. 预测
[未来 3-5 年预测，标注来源和假设条件]

### 7. 数据来源
[所有引用和数据出处]
```

---

## 学术文献调研模板

```markdown
# 文献调研: {{RESEARCH_TOPIC}}

## 目标
综述 {{RESEARCH_TOPIC}} 领域的研究进展、关键论文和开放问题。

## 数据源
- 学术数据库: arXiv, Semantic Scholar, Google Scholar
- 会议论文: {{RELEVANT_CONFERENCES}}
- 预印本服务器

## 约束
- 检索轮数: ≤15 轮
- 优先近 2 年论文，经典论文例外
- 标注论文引用量和发表场所

## 输出结构

### 1. 领域概述
- 研究问题定义
- 历史发展脉络
- 当前研究热点

### 2. 关键论文
| 论文 | 作者 | 年份 | 贡献 | 引用量 |
|-----|-----|-----|-----|-------|
| [标题](URL) | ... | ... | ... | ... |

### 3. 方法分类
```
方法A
├── 子方法A1
│   └── 代表论文: ...
└── 子方法A2
    └── 代表论文: ...

方法B
└── ...
```

### 4. 数据集与基准
| 数据集 | 规模 | 任务 | 链接 |
|-------|-----|-----|-----|
| ... | ... | ... | ... |

### 5. 关键作者/团队
- [作者名] ([机构]) - 研究方向: ...

### 6. 开放问题
1. [问题1] - 当前进展和挑战
2. [问题2] - ...

### 7. 参考文献
[完整引用列表，按引用频次排序]
```

---

## 📊 数据提取模板（📦 处理型 + 📊 结构化）

**适用场景**：用户提供已知数据源（URL 列表、文件、数据库），需要结构化提取和处理。

**维度组合**：`📦 处理型` × `📊 结构化输出`

**与发现型任务的核心区别**：
- ❌ 不强制要求"原文摘录"（数据本身即为证据）
- ✅ 强制要求数据完整性（≥95% 覆盖率）
- ✅ 强制要求结构化输出（JSON/表格）
- ✅ 强制要求来源追溯（每条数据标注来源 URL）

```markdown
# 数据提取任务: {{TASK_NAME}}

## 任务类型声明
⚠️ 本任务为【📦 处理型 + 📊 结构化】，质量指标为数据完整性，非证据密度。

## 背景
{{CONTEXT}}

## 数据源清单
已知数据源（共 {{SOURCE_COUNT}} 个）：
{{SOURCE_LIST}}

## 提取目标
从上述数据源中提取以下字段：
{{FIELD_DEFINITIONS}}

## 约束条件
- 必须访问所有数据源（完整性目标：≥95%）
- 每条提取数据必须标注来源 URL
- 无法访问的数据源需记录失败原因
- 不使用 EnterPlanMode 或 AskUserQuestion
- 提取轮数不超过 {{MAX_ROUNDS}} 轮

## 输出格式【强制遵守】

### ⚠️ 处理型任务格式合规声明
本输出为处理型数据提取任务，遵循 Wide Research 数据完整性规范。

---

### 数据提取统计
- 数据源总数: {{SOURCE_COUNT}}
- 成功提取: X 个 (X%)
- 提取失败: X 个 (X%)
- 数据完整性: X% (目标 ≥95%)

---

### 提取结果（JSON 格式）

```json
{
  "metadata": {
    "source_type": "processing",
      "output_format": "structured",
    "total_sources": {{SOURCE_COUNT}},
    "successful_extractions": X,
    "failed_extractions": X,
    "completeness_rate": "X%",
    "extraction_timestamp": "YYYY-MM-DD HH:MM"
  },
  "data": [
    {
      "id": 1,
      "source_url": "{{URL}}",
      "source_name": "{{NAME}}",
      "extracted_fields": {
        "field1": "value1",
        "field2": "value2"
      },
      "extraction_status": "success"
    },
    {
      "id": 2,
      "source_url": "{{URL}}",
      "source_name": "{{NAME}}",
      "extracted_fields": null,
      "extraction_status": "failed",
      "failure_reason": "404 Not Found"
    }
  ]
}
```

---

### 提取结果（表格格式，供报告使用）

| # | 来源名称 | 字段1 | 字段2 | 字段3 | 状态 | 来源URL |
|---|---------|-------|-------|-------|------|---------|
| 1 | ... | ... | ... | ... | ✅ | [链接](URL) |
| 2 | ... | ... | ... | ... | ❌ | [链接](URL) |

---

### 失败记录

| # | 来源 | 失败原因 | 建议处理 |
|---|------|---------|---------|
| 1 | [来源名](URL) | 404 页面不存在 | 跳过 |
| 2 | [来源名](URL) | 反爬虫限制 | 手动访问 |

---

### 数据质量报告
- **完整性**: X/Y 数据源成功提取 (X%)
- **一致性**: 字段格式是否统一
- **准确性**: 抽查验证结果

---

## ⛔ 处理型结构化输出禁止清单
- 禁止跳过任何数据源而不记录原因
- 禁止输出无来源 URL 的数据
- 禁止将提取失败的数据源计入成功统计
- 禁止完整性低于 90% 且无说明
```

---

### 数据提取子任务模板（并行执行）

**用于将大量数据源拆分为子任务并行处理：**

```markdown
# 数据提取子任务 {{SUBTASK_ID}}/{{TOTAL_SUBTASKS}}

## 任务类型
📦 处理型 + 📊 结构化（数据提取子任务）

## 负责的数据源（共 {{BATCH_SIZE}} 个）
{{BATCH_SOURCE_LIST}}

## 提取字段
{{FIELD_DEFINITIONS}}

## 约束
- 必须访问本批次所有 {{BATCH_SIZE}} 个数据源
- 每条数据必须标注来源 URL
- 超时限制: {{TIMEOUT_MINUTES}} 分钟

## 输出格式

### 子任务统计
- 批次: {{SUBTASK_ID}}/{{TOTAL_SUBTASKS}}
- 负责数据源: {{BATCH_SIZE}} 个
- 成功提取: X 个
- 失败: X 个

### 提取数据
[JSON 数组，每个元素包含 source_url, extracted_fields, status]

### 失败记录
[失败的数据源及原因]
```

---

## 📚 内容整理模板（📦 处理型 + 📝 叙事性）

**适用场景**：整理、归纳已知数据源（文献、文档、博客等）的核心观点，生成综述报告。

**维度组合**：`📦 处理型` × `📝 叙事性输出`

**关键点**：数据源已知，无需搜索发现。用户已提供 URL 列表、PDF 文件或明确的文档范围。

**与发现型任务的区别**：
- 原文摘录：可选（重点是覆盖率）
- 允许使用学术引用格式（作者-年份制）
- 允许对原文进行归纳总结（非强制逐字引用）
- 质量指标：覆盖率 ≥95%（是否覆盖了所有给定数据源）

```markdown
# 内容整理: {{TOPIC}}

## 任务类型声明
⚠️ 本任务为【📦 处理型 + 📝 叙事性】，使用学术引用格式，质量指标为覆盖率。

## 背景
{{CONTEXT}}

## 文献来源
{{LITERATURE_SOURCES}}

## 综述目标
{{OBJECTIVES}}

## 约束条件
- 每个核心论点需 ≥2 条文献支撑
- 使用作者-年份引用格式
- 区分直接引用和归纳总结
- 标注每篇文献的可信度/影响力

## 输出格式【强制遵守】

### ⚠️ 处理型叙事任务格式合规声明
本输出为内容整理任务，以覆盖率为核心指标。引用格式可选学术规范。

---

### 综述概要
[1-2 段总结本综述的核心发现]

---

### 主题 1: [标题]

**核心论点**：
[简洁陈述]

**文献支撑**（≥2 条）：
1. **直接引用**：
   > "[原文]" (Author, Year, p.XX)

2. **归纳总结**：
   [作者] (Year) 指出... [归纳内容，非原文]
   - 来源：[论文标题], [期刊/会议], [链接](URL)

**跨文献分析**：
[比较不同文献的观点异同]

---

### 主题 2: [标题]
[同上结构]

---

### 文献引用表

| # | 作者 | 年份 | 标题 | 来源 | 影响力 | 链接 |
|---|------|-----|------|------|--------|------|
| 1 | ... | ... | ... | ... | 高/中/低 | [链接](URL) |

---

### 研究空白与未来方向
[基于文献综述发现的研究空白]

---

## ⛔ 处理型叙事输出禁止清单
- 禁止核心论点无文献支撑
- 禁止混淆直接引用和归纳总结
- 禁止遗漏引用格式（作者-年份）
- 禁止文献来源无链接
```

---

## Prompt 变量说明

| 变量 | 说明 | 示例 |
|-----|------|-----|
| `{{TASK_NAME}}` | 子任务名称 | "调研 GitHub Copilot" |
| `{{CONTEXT}}` | 任务背景说明 | "作为 AI 代码助手市场分析的一部分..." |
| `{{OBJECTIVE}}` | 具体目标 | "获取产品功能、定价、用户反馈信息" |
| `{{PRIMARY_SOURCES}}` | 主要数据源 | "官方网站, 产品文档" |
| `{{SECONDARY_SOURCES}}` | 备选数据源 | "用户评价, 新闻报道" |
| `{{MAX_SEARCH_ROUNDS}}` | 检索轮数上限 | 10 |
| `{{TIMEOUT_MINUTES}}` | 超时时间 | 5 |

---

## 动态 Prompt 生成示例

```python
# Python 示例: 生成子任务 prompt
def generate_subtask_prompt(
    task_name: str,
    objective: str,
    primary_sources: list[str],
    max_rounds: int = 10,
    timeout: int = 5
) -> str:
    template = """# 子任务: {task_name}

## 目标
{objective}

## 数据源
- 主要来源: {primary_sources}

## 约束
- 检索轮数不超过 {max_rounds} 轮
- 执行时间不超过 {timeout} 分钟
- 必要信息齐全即可结束

## 输出格式
### 核心发现
[3-5 点，每点附引用]

### 详细分析
[展开内容]

### 证据清单
| 证据 | 来源 | 可信度 |
|-----|------|-------|

### 失败处理
如无法完成，输出失败原因和已完成部分。
"""
    return template.format(
        task_name=task_name,
        objective=objective,
        primary_sources=", ".join(primary_sources),
        max_rounds=max_rounds,
        timeout=timeout
    )
```

---

## 子代理执行检查清单

每个子代理应在执行前确认：

- [ ] 目标明确，可量化
- [ ] 数据源可访问
- [ ] 约束条件理解正确
- [ ] 输出格式模板就绪
- [ ] 失败处理方案准备
- [ ] 🆕 理解增量写入模式要求

执行后确认：

- [ ] 核心发现已列出
- [ ] 所有引用有链接
- [ ] 局限性已说明
- [ ] 输出写入指定文件
- [ ] 🆕 每个发现都已增量写入（非一次性写入）
- [ ] 🆕 使用 Edit 追加而非 Write 覆盖
