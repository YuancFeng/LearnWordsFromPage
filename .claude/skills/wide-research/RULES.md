# Wide Research 强制规则

本文档列出所有**必须遵守**的强制规则，违反任何一条都会导致输出质量不合格。

---

## 第一部分：执行约束

### 1. 模型与推理档位

```
默认规则：
- 子任务使用 model: "haiku" 以控制成本和速度
- 仅在子任务输出质量明显不足时，经用户授权后提升档位
- 主控默认使用当前模型，不主动降级
```

**禁止行为：**
- ❌ 未经授权擅自使用更高档位模型
- ❌ 子任务默认使用高档位模型

### 2. 并行度控制

```
默认并行数：8 个子任务

规则：
- < 8 个子任务：全部并行启动
- 8-16 个子任务：分 2 批，每批 8 个
- > 16 个子任务：分批执行，每批 8 个
```

**关键约束：**
- ✅ 所有独立子任务必须在**单条消息**中启动
- ❌ 禁止串行逐个执行
- ❌ 禁止主控"随便搜搜"来替代并行子任务

### 3. 主控职责边界

```
主控应该做：
- Phase 0 摸底（亲自完成，不委托）
- 准备 prompt 和模板
- 审阅生成的 prompt 文件
- 聚合和润色结果
- 双重质检

主控不应该做：
- 亲自执行大量下载/解析
- 替代子任务做调研
- 跳过子任务直接产出报告
```

**强制规则：数据量足够时，主控不亲自执行下载、解析等重活，这些必须通过子任务完成。**

### 4. 子任务不交互

```
子任务 Prompt 必须包含：
"不使用 plan 工具与人工交互等待。
 必要信息齐全即可结束，不追求完美覆盖。"
```

**禁止行为：**
- ❌ 子任务中使用 EnterPlanMode
- ❌ 子任务中使用 AskUserQuestion
- ❌ 子任务等待外部确认

### 5. 验证后再并行

```
强制流程：
1. 先串行执行 1-2 个子任务作为验证
2. 确认以下内容正常：
   - Tavily/MCP 接口可用
   - Prompt 格式正确
   - 输出路径可写
   - 缓存机制工作
3. 验证通过后才能全面并行
```

**禁止行为：**
- ❌ 未验证直接启动全部子任务
- ❌ 跳过验证步骤

---

## 第二部分：Tavily/MCP 参数规范

### 必须使用的默认参数

```javascript
mcp__tavily-mcp__tavily_search({
  query: "...",
  max_results: 6,              // 固定值，覆盖不足时可提至 10
  search_depth: "advanced",    // 固定值，总是使用 advanced
  include_images: true,        // 默认开启，除非用户要求纯文本
  include_image_descriptions: true
})
```

### 禁止使用的参数

```javascript
// ❌ 禁止使用 include_raw_content
include_raw_content: true  // 会返回超大原文，禁用
```

### 图像检索规则

```
默认行为：开启图像检索
例外情况：仅当用户明确要求"纯文本"时关闭

图像结果处理：
- 在报告中与文本一并呈现
- 标注图像来源
```

### 检索轮数限制

```
子任务 Prompt 必须包含检索轮数限制：

"限制 Tavily 搜索/抽取总轮数不超过 X 轮
 （根据任务复杂度：简单任务 5 轮，标准任务 10 轮，复杂任务 15 轮）
 必要信息齐全即可结束。"
```

---

## 第三部分：输出格式强制规则

### 1. UTF-8 编码

```
所有结构化输出必须是合法的 UTF-8 文本。
禁止输出包含：
- 非法 UTF-8 字节序列
- 未转义的控制字符
- BOM 头（在 JSON/MD 中）
```

### 2. 引用格式（内联强制）

```markdown
✅ 正确（内联引用）：
GitHub Copilot 月活超 130 万用户 [来源](https://github.blog/2024-stats)。

❌ 错误（集中引用）：
GitHub Copilot 月活超 130 万用户。[1]

参考文献：
[1] https://github.blog/2024-stats
```

**强制规则：每条要点后直接以 Markdown 链接形式附上来源，禁止将链接集中到段尾。**

### 3. 数据时间标注

```markdown
✅ 正确：
市场规模: $50B (2024年预测, Gartner, 2024-01)

❌ 错误：
市场规模: $50B
```

**强制规则：所有引用数据必须标注来源和时间。**

### 4. 禁止机械截断

```python
# ❌ 禁止
summary = content[:500] + "..."

# ✅ 正确
# 必须处理完整原文后再总结
summary = extract_key_points(full_content)
```

**强制规则：在需要总结或提炼内容时，必须先处理完整原文，不得简单截取固定长度。**

### 5. 禁止直接拼接

```markdown
❌ 错误（直接拼接子任务输出）：
## 子任务1结果
[子任务1原始输出]

## 子任务2结果
[子任务2原始输出]

✅ 正确（综合整理后的结构化报告）：
## 市场概况
基于对 X 个产品的调研，市场呈现以下特点...

## 关键发现
1. [整合后的发现1] [来源](URL)
2. [整合后的发现2] [来源](URL)
```

**强制规则：最终交付物禁止直接拼接子任务原始 Markdown，必须重新组织结构。**

### 6. 禁止一次性生成

```
润色流程强制要求：
1. 逐章撰写
2. 每完成一章立即自查
3. 必要时回溯子稿核实
4. 记录每章的亮点、问题与处理方式

禁止行为：
- ❌ 一次性生成整篇报告
- ❌ 整篇删除后重写
```

### 7. 证据链保留（核心规则）

```
原则：结论必须可追溯、可验证

每个核心发现必须包含：
1. 结论陈述（1-2 句）
2. 原文摘录（≥3 条直接引用）
3. 来源标注（出处 + URL）
```

**禁止行为：**
- ❌ 裸结论（没有原文支撑的陈述）
- ❌ 过度概括（将多条证据压缩为一句模糊总结）
- ❌ 改写原文（必须保持原始表述）
- ❌ 丢弃引用（聚合时删除子任务中的原文摘录）

**强制格式：**
```markdown
**发现**：[结论陈述]

**原文摘录**：
> "[原始引用1]" —— 来源A [链接](URL)
> "[原始引用2]" —— 来源B [链接](URL)
> "[原始引用3]" —— 来源C [链接](URL)

**分析**：[基于证据的深入分析]
```

**为什么重要**：
- 读者能验证结论可信度
- 决策者能追溯数据来源
- 避免"空洞的专家意见"
- 提高报告权威性和实用性

---

## 第四部分：质检强制规则

### 🔴 子代理输出验证（Phase 3 后必做）

**此规则解决"子代理没有遵守原文摘录要求"的核心问题**

```
每个子任务输出必须通过以下验证：

验证 1：原文存在性
问题：输出中是否包含 > "..." 格式的原文摘录？
- 是 → 继续验证 2
- 否 → 【退回】要求子代理重新执行或标记为无效

验证 2：原文数量
问题：每个发现是否有 ≥3 条原文摘录？
- 是 → 继续验证 3
- 否 → 【标记不完整】记录缺失数量

验证 3：原文质量
问题：摘录是否为直接引用（带引号）而非改写？
- 是 → 通过验证
- 否 → 【退回】要求提取原文

验证 4：来源有效性
问题：每条原文是否有可点击的 URL？
- 是 → 通过验证
- 否 → 【标记缺失来源】
```

**验证失败处理流程**：

```
失败类型 → 处理方式

1. 完全无原文
   → 退回子代理，重新执行
   → 或标记为"无效输出"，不纳入聚合

2. 原文数量不足
   → 记录到聚合报告
   → 主控补充检索或标注"证据不足"

3. 原文为改写
   → 退回要求提取原始表述
   → 或主控亲自验证来源并补充

4. 缺少 URL
   → 主控尝试补充
   → 无法补充则标注"来源待验证"
```

**验证脚本伪代码**：

```python
def validate_subtask_output(output: str) -> dict:
    """验证子任务输出是否符合证据链规范"""
    findings = extract_findings(output)
    result = {
        "valid": True,
        "issues": [],
        "stats": {"findings": len(findings), "quotes": 0}
    }

    for finding in findings:
        quotes = extract_quotes(finding)  # 提取 > "..." 格式
        result["stats"]["quotes"] += len(quotes)

        if len(quotes) == 0:
            result["valid"] = False
            result["issues"].append(f"发现'{finding.title}'无原文摘录")
        elif len(quotes) < 3:
            result["issues"].append(f"发现'{finding.title}'原文不足3条")

        for quote in quotes:
            if not has_url(quote):
                result["issues"].append(f"原文'{quote[:20]}...'缺少URL")
            if is_paraphrased(quote):  # 检测是否为改写
                result["issues"].append(f"原文'{quote[:20]}...'疑似改写")

    result["density"] = result["stats"]["quotes"] / max(len(findings), 1)
    return result
```

---

### 双重质检（交付前必做）

```
质检 1：结构检查
问题：成稿是否通过分章节、多轮整合完成？
- 是 → 继续质检 2
- 否 → 退回，按章节重写

质检 2：深度检查
问题：全文是否足够详实？
- 是 → 继续质检 3
- 否 → 判断原因：
  - 子任务素材不足 → 补充调研
  - 统稿压缩过度 → 扩展润色

质检 3：证据密度检查 【新增】
问题：报告原文密度是否达标？
计算：原文密度 = 原文总数 / 核心发现数
- 快速调研：密度 ≥ 2.0 → 通过
- 标准调研：密度 ≥ 3.0 → 通过
- 深度调研：密度 ≥ 5.0 → 通过
- 未达标 → 补充证据或降低报告定位
```

### 覆盖率校验

```
批量生成结束后必须执行覆盖率校验：
- 统计缺失条目
- 统计空字段
- 统计标签数量
- 统计原文摘录总数 【新增】
- 计算证据密度 【新增】
- 确保问题在报告前被发现并补救
```

### 证据密度指标（强制达标）

| 报告类型 | 核心发现数 | 每发现原文数 | 总原文下限 | 密度要求 |
|---------|----------|------------|----------|---------|
| 快速调研 | 3-5 | ≥2 | 10 | ≥2.0 |
| 标准调研 | 5-8 | ≥3 | 25 | ≥3.0 |
| 深度调研 | 8-12 | ≥5 | 50 | ≥5.0 |

**不达标后果**：
- 原文密度 < 要求 → 报告不得交付
- 必须补充证据或将报告降级为更低定位

---

## 第五部分：超时与重试规则

### 超时阈值

| 任务类型 | 初始超时 | 重试超时 | 最大超时 |
|---------|---------|---------|---------|
| 简单搜索 | 3 分钟 | 5 分钟 | 5 分钟 |
| 标准调研 | 5 分钟 | 10 分钟 | 15 分钟 |
| 复杂分析 | 10 分钟 | 15 分钟 | 15 分钟 |

### 超时处理

```
5 分钟超时：
- 评估任务是否需要拆分
- 调整参数后重试

15 分钟超时：
- 视作 prompt 或流程问题
- 记录到日志待排查
- 不再重试，标记 [TIMEOUT]
```

### 重试规则

```
抓取类任务必须尝试至少 2 次：
1. 首次失败后自动重试
2. 重试前检查缓存是否已有结果
3. 若仍失败，在输出中新增"失败原因/后续建议"小节
4. 确保聚合阶段不会出现空白
```

---

## 第六部分：交付强制规则

### 交付物要求

```
1. 最终交付物必须落地为独立文件
2. 通过提供文件路径与摘要向用户回报
3. 禁止在聊天中贴出完整成稿
4. 不向用户附带中间稿或内部笔记
```

### 聊天回复格式

```markdown
✅ 正确：

## 调研完成

最终报告已生成: `runs/20260106-ai-market-a3f2c1/final_report.md`

### 核心结论
1. [结论1]
2. [结论2]

### 可执行建议
- [建议1]
- [建议2]

完整报告请查看上述路径。

---

❌ 错误：
[直接贴出 3000 字完整报告]
```

---

## 第七部分：幂等性与安全规则

### 幂等性

```
每次运行必须生成新的工作目录：
runs/<日期>-<摘要>-<随机后缀>/

禁止行为：
- ❌ 覆盖已有工作目录
- ❌ 修改其他运行的输出
- ❌ 删除历史运行数据
```

### 权限控制

```
默认权限：sandbox 限制
提升权限：仅在确有必要且获得授权时

禁止行为：
- ❌ 擅自提升权限
- ❌ 使用危险的 bypass 选项
```

### 子任务隔离

```
子任务 Prompt 必须明确约束：
- 只访问指定 URL/目录
- 只使用允许的工具
- 不越界访问其他资源
```

---

## 违规后果

违反上述任何强制规则将导致：

1. **输出不合格** - 需要重做
2. **质检不通过** - 退回修改
3. **交付被拒绝** - 无法完成任务

主控在执行前应逐条确认这些规则，确保流程符合规范。
