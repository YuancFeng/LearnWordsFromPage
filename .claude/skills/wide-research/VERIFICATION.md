# Wide Research 验证清单

本文档提供各阶段的强制验证清单，确保子代理输出和最终报告符合质量标准。

---

## 核心原则

**验证不是可选步骤，是强制流程。**

```
验证目的：
1. 确保子代理遵守原文摘录规则
2. 防止无证据结论进入最终报告
3. 保证报告证据密度达标
4. 维护结论可追溯性
```

---

## Phase 3 后：子代理输出验证

### 单个子任务验证清单

**对每个子任务输出执行以下检查：**

```markdown
## 子任务验证: [子任务名称]

### 1. 原文存在性检查
- [ ] 输出中包含 > "..." 格式的原文摘录
- [ ] 原文使用引号包裹
- [ ] 原文后有来源标注

检查方法：搜索 `> "` 或 `> 「` 模式
通过标准：至少存在 3 处匹配

### 2. 原文数量检查
- [ ] 核心发现 1 有 ≥3 条原文
- [ ] 核心发现 2 有 ≥3 条原文
- [ ] 核心发现 3 有 ≥3 条原文
- [ ] ...

检查方法：统计每个"发现"区块下的 > 行数
通过标准：每个发现 ≥3 条

### 3. 原文质量检查
- [ ] 原文是直接引用，非改写
- [ ] 原文包含具体细节/数据
- [ ] 原文来自不同来源（多样性）

检查方法：人工审阅，判断是否为原始表述
通过标准：无明显改写痕迹

### 4. 来源有效性检查
- [ ] 每条原文有可点击 URL
- [ ] URL 指向可访问页面
- [ ] 来源名称准确

检查方法：提取所有 [链接](URL)，验证格式
通过标准：100% 原文有 URL

### 5. 统计汇总
- 发现数量: ___
- 原文总数: ___
- 证据密度: ___ (原文数/发现数)
- 有效 URL 数: ___

### 6. 验证结论
- [ ] 通过：可纳入聚合
- [ ] 不完整：需补充后纳入
- [ ] 无效：退回重做或标记排除
```

---

### 批量验证汇总表

**所有子任务完成后填写：**

| 子任务 | 发现数 | 原文数 | 密度 | URL完整 | 状态 |
|-------|-------|-------|------|---------|------|
| 子任务1 | _ | _ | _ | _% | ✅/⚠️/❌ |
| 子任务2 | _ | _ | _ | _% | ✅/⚠️/❌ |
| 子任务3 | _ | _ | _ | _% | ✅/⚠️/❌ |
| ... | ... | ... | ... | ... | ... |
| **总计** | **_** | **_** | **_** | **_**% | - |

**状态说明**：
- ✅ 通过：完全符合要求
- ⚠️ 不完整：部分符合，需标注
- ❌ 无效：不纳入聚合

---

## Phase 4：聚合前验证

### 聚合准入检查

```markdown
## 聚合准入验证

### 1. 覆盖完整性
- [ ] 所有子任务有输出（成功/失败/超时）
- [ ] 失败任务已标记原因
- [ ] 无遗漏的子任务

### 2. 证据链完整性
- [ ] ≥80% 子任务通过验证
- [ ] 无效输出已排除或重做
- [ ] 证据密度达到最低要求

### 3. 聚合规则确认
- [ ] 理解"聚合 ≠ 压缩"原则
- [ ] 准备保留所有原文摘录
- [ ] 准备分类整理而非删减

### 准入决策
- [ ] 通过：开始聚合
- [ ] 补充：需要额外调研
- [ ] 暂停：问题过多，需排查
```

---

## Phase 4 后：聚合结果验证

### 聚合质量检查

```markdown
## 聚合结果验证

### 1. 原文保留检查
计算：保留率 = 聚合后原文数 / 子任务原文总数

- 子任务原文总数: ___
- 聚合后原文数: ___
- 保留率: ___%

通过标准：保留率 ≥ 80%

### 2. 结构检查
- [ ] 按主题/维度重新组织
- [ ] 未直接拼接子任务输出
- [ ] 有清晰的章节结构

### 3. 证据归属检查
- [ ] 每个原文标注支撑哪个发现
- [ ] 无"孤立原文"（不属于任何发现）
- [ ] 无"裸发现"（没有原文支撑）

### 验证结论
- [ ] 通过：可进入润色阶段
- [ ] 需调整：证据链有缺失
- [ ] 退回：严重不符合规范
```

---

## Phase 5 前：润色预检

### 润色前验证清单

```markdown
## 润色预检

### 1. 素材完备性
- [ ] aggregated_raw.md 已生成
- [ ] 证据密度统计已完成
- [ ] 问题区域已标注

### 2. 大纲准备
- [ ] polish_outline.md 已创建
- [ ] 每章有明确的素材来源
- [ ] 核心论点已提炼

### 3. 格式规范确认
- [ ] 了解内联引用格式要求
- [ ] 了解数据时间标注要求
- [ ] 了解三层结构要求

### 预检结论
- [ ] 通过：开始逐章撰写
- [ ] 补充：需要额外素材
```

---

## Phase 5 后：交付前终检

### ⚠️ 重要：根据两维度选择验证清单

```
两维度判断 → 选择对应的验证清单

维度一：数据来源
├── 🔍 发现型 → 使用"证据密度终检"（严格证据链规则）
└── 📦 处理型 → 使用"数据完整性终检"（完整性优先规则）

维度二：输出格式（决定检查重点）
├── 📊 结构化 → 重点检查 JSON/表格格式合规性
└── 📝 叙事性 → 重点检查报告结构完整性
```

---

### 最终报告验证清单（🔍 发现型任务）

```markdown
## 交付前终检（🔍 发现型）

### 1. 证据密度终检
- 核心发现数: ___
- 原文摘录总数: ___
- 证据密度: ___

| 报告定位 | 🔍 发现型要求 | 实际密度 | 是否达标 |
|---------|--------------|---------|---------|
| 快速调研 | ≥2.0 | ___ | ✅/❌ |
| 标准调研 | ≥3.0 | ___ | ✅/❌ |
| 深度调研 | ≥5.0 | ___ | ✅/❌ |

### 2. 格式合规检查
- [ ] 所有引用为内联格式 [来源](URL)
- [ ] 所有数据有时间标注
- [ ] 无集中式参考文献
- [ ] 无裸数据（无来源的数字）

### 3. 三层结构检查
- [ ] 第一层：核心洞察存在
- [ ] 第二层：证据支撑存在
- [ ] 第三层：完整素材可查

### 4. 文件完整性
- [ ] final_report.* 已生成
- [ ] 位于正确的 runs/ 目录
- [ ] metadata.json 已更新
- [ ] 所有中间文件保留

### 5. 内容完整性
- [ ] 执行摘要存在
- [ ] 所有章节已完成
- [ ] 结论与建议存在
- [ ] 局限性说明存在

### 终检结论
- [ ] 通过：可以交付
- [ ] 修改：需要调整后交付
- [ ] 退回：质量不达标，需重做
```

---

### 最终报告验证清单（📦 处理型任务）

```markdown
## 交付前终检（📦 处理型）

### 1. 数据完整性终检（替代证据密度）
- 数据源总数: ___
- 成功提取数: ___
- 失败数: ___
- 完整性: ___%

| 完整性等级 | 要求 | 实际 | 是否达标 |
|-----------|------|------|---------|
| 合格 | ≥90% | ___% | ✅/❌ |
| 良好 | ≥95% | ___% | ✅/❌ |
| 优秀 | ≥99% | ___% | ✅/❌ |

### 2. 数据追溯检查（替代原文摘录检查）
- [ ] 每条数据有来源 URL
- [ ] 失败数据源有记录原因
- [ ] JSON/表格格式正确
- [ ] 字段定义一致

### 3. 结构化输出检查
- [ ] 提供 JSON 格式数据
- [ ] 提供表格格式数据
- [ ] metadata 完整（总数、成功数、时间戳）
- [ ] 失败记录表存在

### 4. 文件完整性
- [ ] final_report.* 已生成
- [ ] raw/ 目录下有 JSON 原始数据
- [ ] 位于正确的 runs/ 目录
- [ ] metadata.json 已更新

### 5. 内容完整性
- [ ] 数据提取统计存在
- [ ] 提取结果（JSON + 表格）存在
- [ ] 失败记录存在
- [ ] 数据质量报告存在

### 终检结论
- [ ] 通过：完整性 ≥95%，可以交付
- [ ] 修改：完整性 90-95%，需补充说明
- [ ] 退回：完整性 <90%，需重做或手动补充

### 📊 结构化输出额外检查（如适用）
- [ ] JSON 格式有效（可解析）
- [ ] 表格列数一致
- [ ] 字段命名统一

### 📝 叙事性输出额外检查（如适用）
- [ ] 章节结构完整
- [ ] 覆盖所有给定数据源/文献
- [ ] 引用格式一致
```

---

## 🔴 Phase 5.5: 交付前自审（所有类型强制）

**这是解决"数据管道正确但最后一公里渲染失败"问题的关键检查点。**

### ⚠️ 核心原则

```
数据正确 ≠ 呈现正确

即使数据管道完全成功，最终报告可能因为：
- CSS/样式限制导致内容被截断
- JavaScript 渲染逻辑错误
- 折叠/展开组件初始状态问题
- 分页/滚动容器高度不足
- 图表/可视化未正确加载

导致用户看到的内容不完整。必须自审！
```

### 5.5.1 渲染完整性检查（HTML 报告）

```markdown
## 渲染完整性自审清单

### 1. 数据-视图一致性
- [ ] 统计报告的数据总数与实际显示条目数一致
- [ ] 列表/表格的行数与源数据条目数一致
- [ ] 折叠区域展开后能看到所有内容
- [ ] 分页组件能访问所有页面

### 2. 交互组件检查
- [ ] 所有可折叠区域都能展开/收起
- [ ] 所有标签页/Tab 都能切换
- [ ] 搜索/筛选功能正常工作
- [ ] 排序功能正常工作（如有）

### 3. 视觉完整性
- [ ] 无内容被 CSS overflow 截断
- [ ] 无元素超出容器边界
- [ ] 滚动区域能滚动到底部
- [ ] 长列表能完整显示

### 4. 数据绑定验证
若报告使用 JavaScript 动态渲染：
- [ ] 检查 JS 数组/对象的长度
- [ ] 确认渲染函数被正确调用
- [ ] 验证 DOM 元素数量与数据长度匹配
```

### 5.5.2 快速自审方法

**方法 1：计数对比**
```javascript
// 在浏览器控制台执行
// 检查数据数组长度
console.log("数据总数:", blogData.length);  // 或其他数据变量

// 检查实际渲染的 DOM 元素数
console.log("显示条目数:", document.querySelectorAll('.item-class').length);

// 两者应该相等！
```

**方法 2：高度检查**
```javascript
// 检查容器实际高度 vs 内容高度
const container = document.querySelector('.content-container');
console.log("容器高度:", container.clientHeight);
console.log("内容高度:", container.scrollHeight);
// 若 scrollHeight > clientHeight 且无滚动条，内容被截断！
```

**方法 3：展开验证**
```
1. 找到所有可折叠区域
2. 逐个展开
3. 检查展开后的内容是否完整
4. 特别注意：展开后是否有"更多"或滚动
```

### 5.5.3 常见渲染问题与修复

| 问题 | 症状 | 修复方法 |
|------|------|---------|
| max-height 过小 | 内容被截断 | 增大 max-height 或改为 auto |
| overflow: hidden | 内容不可见 | 改为 overflow: auto/visible |
| 虚拟滚动bug | 只渲染部分 | 检查虚拟列表配置 |
| 懒加载未触发 | 内容未加载 | 手动触发或修改阈值 |
| JS 渲染循环错误 | 只显示第一条 | 检查循环逻辑 |

### 5.5.4 自审报告模板

```markdown
## 交付前自审报告

### 数据层验证
- 数据源条目数: ___
- JSON/数组长度: ___
- ✅/❌ 数据完整

### 渲染层验证
- 列表/表格显示行数: ___
- 可折叠区域数: ___
- 展开后完整: ✅/❌

### 一致性检查
- 数据条目数 = 显示条目数: ✅/❌
- 若不一致，差异原因: ___

### 自审结论
- [ ] 通过：数据与呈现完全一致，可交付
- [ ] 问题：发现渲染问题，需修复后交付
  - 问题描述: ___
  - 修复方案: ___
```

### 5.5.5 强制执行规则

```
⛔ 以下情况禁止交付：

1. 数据条目数 ≠ 显示条目数（未说明原因）
2. 存在被截断的内容区域
3. 可折叠区域展开后为空或不完整
4. 统计数字与实际列表不匹配

✅ 允许交付的情况：

1. 数据与呈现完全一致
2. 存在差异但已在报告中说明原因
3. 渲染问题已修复
```

---

## 快速验证命令

### 检查原文摘录数量

```bash
# 统计 > "..." 格式的原文数量
grep -c '> "' outputs/subtask_*.md

# 统计每个文件的原文数
for f in outputs/subtask_*.md; do
  echo "$f: $(grep -c '> \"' $f) quotes"
done
```

### 检查 URL 完整性

```bash
# 提取所有 URL
grep -oE '\[.*?\]\(https?://[^)]+\)' outputs/*.md

# 统计 URL 数量
grep -c 'https://' outputs/subtask_*.md
```

### 计算证据密度

```bash
# 简易密度计算
findings=$(grep -c '### 发现' aggregated_raw.md)
quotes=$(grep -c '> "' aggregated_raw.md)
echo "密度: $(echo "scale=2; $quotes / $findings" | bc)"
```

---

## 验证失败处理流程

```
┌─────────────────────────────────────┐
│        子任务输出验证失败            │
└─────────────────┬───────────────────┘
                  │
        ┌─────────┴─────────┐
        ▼                   ▼
   完全无原文          原文不足/有缺陷
        │                   │
        ▼                   ▼
   退回重做              标记问题
   或标记无效            继续聚合
        │                   │
        ▼                   ▼
   重新执行子任务      聚合时标注
   或人工补充          "证据不完整"
        │                   │
        └─────────┬─────────┘
                  │
                  ▼
        ┌─────────────────────┐
        │    更新统计表       │
        │  记录处理方式       │
        └─────────────────────┘
```

---

## 违规处理

| 违规类型 | 严重程度 | 处理方式 |
|---------|---------|---------|
| 完全无原文 | 严重 | 退回重做或标记无效 |
| 原文不足 | 中等 | 补充或标注"证据不足" |
| 原文被改写 | 中等 | 要求提取原始表述 |
| 缺少 URL | 轻微 | 补充或标注"来源待验证" |
| 密度不达标 | 中等 | 补充证据或降低定位 |
| 直接拼接 | 严重 | 退回重新组织结构 |

---

## 验证责任分配

| 阶段 | 验证项 | 执行者 |
|-----|-------|-------|
| Phase 3 后 | 子任务输出验证 | 主控 |
| Phase 4 前 | 聚合准入检查 | 主控 |
| Phase 4 后 | 聚合质量检查 | 主控 |
| Phase 5 前 | 润色预检 | 主控 |
| Phase 5 后 | 交付前终检 | 主控 |

**主控必须对所有验证结果负责，不得跳过任何验证步骤。**
